{% extends "layout.html" %}
{% set main_class = "room-card" %}
{% block content %}
  {% if room.phase == "lobby" %}
    {% set phase_label = "Lobby" %}
  {% elif room.phase == "collect" %}
    {% set phase_label = "Palabras" %}
  {% elif room.phase == "voting" %}
    {% set phase_label = "Votacion" %}
  {% else %}
    {% set phase_label = "Resultados" %}
  {% endif %}
  <section class="section">
    <div class="room-header">
      <div>
        <p class="turn">Sala {{ room.code }}</p>
        <h2>Jugador</h2>
      </div>
      <div class="room-meta">
        <span class="pill">Jugadores {{ room.players|length }}</span>
        <span class="pill">Fase {{ phase_label }}</span>
      </div>
    </div>

    {% if notice %}
      <div class="alert">{{ notice }}</div>
    {% endif %}

    <div class="monitor-grid monitor-top">
      <div class="monitor-tile qr-tile">
        <p class="hint">Escanea para entrar</p>
        <img class="qr" src="{{ url_for('room_qr', code=room.code) }}" alt="QR de sala">
        <p class="pill">Sala {{ room.code }}</p>
      </div>
      <div class="monitor-tile category-tile side-tile">
        <div class="tile-header">
          <img src="{{ url_for('static', filename=category_data.image) }}" alt="{{ category_name }}">
          <div>
            <p class="turn">Categoria</p>
            <h3 class="tile-title">{{ category_name }}</h3>
          </div>
        </div>
        <p class="hint">Categoria activa para esta ronda.</p>
      </div>
    </div>

    <div class="monitor-grid monitor-wide">
      <div class="monitor-tile word-bank">
        <p class="turn category-active">{{ category_name }} / Banco visible para todos</p>
        {% set visible_words = category_data.words[:10] %}
        <div class="tile-header">
          <div>
            <h3 class="tile-title">Banco de palabras</h3>
            <p class="hint">{{ visible_words|length }} palabras visibles de {{ category_data.words|length }}</p>
          </div>
        </div>
        <div class="word-wall-grid">
          {% for word in visible_words %}
            <span>{{ word }}</span>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="phase-steps">
      <span class="step-chip {% if room.phase == 'lobby' %}active{% endif %}">Sala</span>
      <span class="step-chip {% if room.phase == 'collect' %}active{% endif %}">Palabras</span>
      <span class="step-chip {% if room.phase == 'voting' %}active{% endif %}">Votacion</span>
      <span class="step-chip {% if room.phase == 'results' %}active{% endif %}">Resultados</span>
    </div>

    <div class="panel">
      <div class="panel-head">
        <h3>Jugadores</h3>
        <p class="hint">{{ room.players|length }} conectados</p>
      </div>
      {% if room.players %}
        <div class="chips">
          {% for person in room.players %}
            <span class="pill">{{ person.name }}</span>
          {% endfor %}
        </div>
      {% else %}
        <p class="hint">Todavia no hay jugadores conectados.</p>
      {% endif %}
    </div>

    {% if not player %}
      <div class="panel">
        {% if room.phase != "lobby" %}
          <p class="hint">La partida ya empezo. Espera la siguiente ronda.</p>
        {% endif %}
        <form method="post" class="form join-form">
          <label>
            Tu nombre
            <input name="name" placeholder="Sol, Nico, Meli" autocomplete="off">
          </label>
          <button class="primary" type="submit">Entrar</button>
        </form>
      </div>
    {% else %}
      {% if room.phase == "lobby" %}
        <div class="panel">
          {% if is_host %}
            <p class="hint">Eres el primer jugador. Inicia cuando todos esten listos.</p>
            <form method="post" action="{{ url_for('start_game', code=room.code) }}">
              <button class="primary" type="submit">Iniciar juego</button>
            </form>
          {% else %}
            <p class="hint">Esperando que el primer jugador inicie la partida.</p>
          {% endif %}
        </div>
      {% elif room.phase == "collect" %}
        <div class="panel highlight">
          <p class="hint">Categoria: {{ room.category_name }}</p>
          <div class="secret">
            {% if is_impostor %}
              <p class="tag danger">Eres el impostor</p>
              <p class="word">No tienes palabra</p>
              <p class="sub">Improvisa y trata de adivinar la palabra real.</p>
            {% else %}
              <p class="tag">Palabra secreta</p>
              <p class="word">{{ secret_word }}</p>
              <p class="sub">Describe sin decirla. Usa creatividad.</p>
            {% endif %}
          </div>
          <form method="post" action="{{ url_for('submit_word', code=room.code) }}" class="form">
            <label>
              Tu palabra para la ronda
              <input name="word" placeholder="Escribe tu palabra">
            </label>
            <button class="primary" type="submit">Enviar palabra</button>
          </form>
          {% if submission %}
            <p class="hint">Tu palabra enviada: {{ submission }}</p>
          {% endif %}
        </div>
        <div class="panel">
          <div class="panel-head">
            <h3>Palabras enviadas</h3>
            <p class="hint" data-submissions-count>{{ submissions_count }}/{{ room.players|length }}</p>
          </div>
          <div class="vote-results" data-submissions-list>
            {% for person in room.players %}
              {% if room.submissions.get(person.id) %}
                <div class="vote-row">
                  <span>{{ person.name }}</span>
                  <span class="pill">{{ room.submissions[person.id] }}</span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <p class="hint" data-submissions-empty {% if room.submissions %}style="display:none"{% endif %}>
            Aun no hay palabras enviadas.
          </p>
        </div>
      {% elif room.phase == "voting" %}
        <div class="panel highlight">
          <p class="hint">Todos enviaron palabra. Hora de votar.</p>
        </div>
        <div class="panel">
          <div class="panel-head">
            <h3>Palabras enviadas</h3>
            <p class="hint" data-submissions-count>{{ submissions_count }}/{{ room.players|length }}</p>
          </div>
          <div class="vote-results" data-submissions-list>
            {% for person in room.players %}
              {% if room.submissions.get(person.id) %}
                <div class="vote-row">
                  <span>{{ person.name }}</span>
                  <span class="pill">{{ room.submissions[person.id] }}</span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <p class="hint" data-submissions-empty {% if room.submissions %}style="display:none"{% endif %}>
            Aun no hay palabras enviadas.
          </p>
        </div>
        {% if has_voted %}
          <p class="hint">Voto enviado. Espera el resultado.</p>
        {% else %}
          <form method="post" action="{{ url_for('vote', code=room.code) }}" class="form">
            <div class="vote-list">
              {% for person in room.players %}
                <label class="vote-option">
                  <input type="radio" name="vote" value="{{ person.id }}" required>
                  <span>{{ person.name }}</span>
                </label>
              {% endfor %}
            </div>
            <button class="primary" type="submit">Enviar voto</button>
          </form>
        {% endif %}
      {% elif room.phase == "results" %}
        <div class="panel">
          <p class="hint">Votacion cerrada. Resultado final de la ronda.</p>
          <div class="impostor-reveal">
            <p class="turn">Revelacion</p>
            <h3>El impostor era...</h3>
            <p class="impostor-name">{{ impostor.name if impostor else 'Sin votos' }}</p>
          </div>
        </div>
        {% if leaderboard %}
          <div class="panel">
            <h3>Resultados de votos</h3>
            <div class="vote-results">
              {% for row in leaderboard %}
                <div class="vote-row">
                  <span>{{ row.name }}</span>
                  <span class="pill">{{ row.votes }} votos</span>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        {% if is_host %}
          <div class="actions">
            <form method="post" action="{{ url_for('reset_round', code=room.code) }}">
              <button class="primary" type="submit">Reiniciar partida</button>
            </form>
          </div>
        {% endif %}
      {% endif %}
    {% endif %}
  </section>
  <script>
    const roomState = {
      phase: "{{ room.phase }}",
      playersCount: {{ room.players|length }},
      submissionsCount: {{ submissions_count }},
      votesCount: {{ votes_count }},
    };
    const stateUrl = "{{ url_for('room_state', code=room.code) }}";
    const submissionsList = document.querySelector("[data-submissions-list]");
    const submissionsCount = document.querySelector("[data-submissions-count]");
    const submissionsEmpty = document.querySelector("[data-submissions-empty]");
    const updateSubmissions = (data) => {
      if (!submissionsList || !submissionsCount) {
        return;
      }
      submissionsCount.textContent = `${data.submissions_count}/${data.players_count}`;
      submissionsList.innerHTML = "";
      if (data.submissions.length === 0) {
        if (submissionsEmpty) {
          submissionsEmpty.style.display = "block";
        }
        return;
      }
      if (submissionsEmpty) {
        submissionsEmpty.style.display = "none";
      }
      data.submissions.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "vote-row";
        const name = document.createElement("span");
        name.textContent = entry.name;
        const word = document.createElement("span");
        word.className = "pill";
        word.textContent = entry.word;
        row.append(name, word);
        submissionsList.appendChild(row);
      });
    };
    setInterval(async () => {
      try {
        const response = await fetch(stateUrl, { cache: "no-store" });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        if (data.phase !== roomState.phase || data.players_count !== roomState.playersCount) {
          window.location.reload();
          return;
        }
        if (data.submissions_count !== roomState.submissionsCount) {
          roomState.submissionsCount = data.submissions_count;
          updateSubmissions(data);
        }
        if (data.votes_count !== roomState.votesCount) {
          roomState.votesCount = data.votes_count;
        }
      } catch (error) {
        // Ignore transient network errors.
      }
    }, 2000);
  </script>
{% endblock %}
